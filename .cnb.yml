# CNBæ„å»ºé…ç½®æ–‡ä»¶
# æ–‡æ¡£å‚è€ƒï¼šhttps://docs.cnb.cool/zh/grammar/pipeline.html

# è§¦å‘è§„åˆ™ï¼šåœ¨ main åˆ†æ”¯æ¨é€æ—¶è§¦å‘
main:
  push:
    - stages:
        - name: ç¼–è¯‘ä¸æ„å»º
          # ä½¿ç”¨ Eclipse Temurin JDK 21ï¼Œä¸é¡¹ç›® Java ç‰ˆæœ¬ä¸€è‡´
          image: docker.io/library/eclipse-temurin:21-jdk
          
          # ç¼“å­˜é…ç½®ï¼šç¼“å­˜ Gradle ä¾èµ–å’Œ Wrapperï¼Œä»¥åŠ Fabric Loom çš„ç¼“å­˜
          # è¿™èƒ½æ˜¾è‘—åŠ å¿«éé¦–æ¬¡æ„å»ºçš„é€Ÿåº¦
          caches:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
            - .gradle/loom-cache
          
          script:
            - echo "ğŸ” æ£€æŸ¥ç¯å¢ƒä¿¡æ¯..."
            - java -version
            
            - echo "ğŸš€ å¼€å§‹æ„å»º..."
            - chmod +x gradlew
            
            # æ‰§è¡Œæ„å»º
            # --no-daemon: CI ç¯å¢ƒä¸ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ï¼ŒèŠ‚çœèµ„æº
            # --build-cache: å¼€å¯ Gradle æ„å»ºç¼“å­˜
            # --stacktrace: å‡ºé”™æ—¶æ‰“å°å †æ ˆä¿¡æ¯
            - ./gradlew build --no-daemon --build-cache --stacktrace
            
            - echo "âœ… æ„å»ºå®Œæˆï¼æ£€æŸ¥äº§ç‰©..."
            - ls -lh build/libs/

        # ------------------------------------------------------------------
        # [å¯é€‰] å‘å¸ƒåˆ° CNB åˆ¶å“åº“ (Maven Registry)
        # å¦‚æœæ‚¨å¸Œæœ›åœ¨ CNB çš„"åˆ¶å“åº“"ä¸­ç®¡ç†å’Œä¸‹è½½æ„å»ºå¥½çš„ JAR åŒ…ï¼Œè¯·å–æ¶ˆä¸‹æ–¹æ³¨é‡Šå¹¶é…ç½®ç¯å¢ƒå˜é‡ã€‚
        #
        # å‰ç½®æ¡ä»¶ï¼š
        # 1. åœ¨ CNB é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ª Maven åˆ¶å“åº“ï¼ˆä¾‹å¦‚åä¸º "maven-repo"ï¼‰ã€‚
        # 2. è·å–åˆ¶å“åº“åœ°å€ï¼Œä¾‹å¦‚ï¼šhttps://maven.cnb.cool/your-group/maven-repo
        # 3. åœ¨é¡¹ç›®è®¾ç½® -> ç¯å¢ƒå˜é‡ä¸­æ·»åŠ ï¼š
        #    - CNB_ARTIFACT_URL: åˆ¶å“åº“åœ°å€
        #    - (CNB_TOKEN é€šå¸¸å†…ç½®å¯ç”¨ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®ï¼Œç”¨æˆ·åä¸º cnb)
        # ------------------------------------------------------------------
        # - name: å‘å¸ƒåˆ°åˆ¶å“åº“
        #   image: docker.io/library/eclipse-temurin:21-jdk
        #   caches:
        #     - ~/.gradle/caches
        #     - ~/.gradle/wrapper
        #     - .gradle/loom-cache
        #   script:
        #     - chmod +x gradlew
        #     - ./gradlew publish --no-daemon
